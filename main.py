import os
import logging
import asyncio
from aiogram import Bot, Dispatcher, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiohttp import web

logging.basicConfig(level=logging.INFO)

BOT_TOKEN = os.environ.get("BOT_TOKEN")
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot)

async def handle(request):
    return web.Response(text="Bot is alive!")

app = web.Application()
app.router.add_get('/', handle)
# ----------------------------------------
QUESTIONS = [
    "Я беспокоюсь о том, что партнёр может меня разлюбить.",
    "Мне некомфортно, когда партнёр становится слишком близким.",
    "Мне важно получать подтверждение чувств партнёра.",
    "Я часто думаю о том, насколько я значим для партнёра.",
    "Я предпочитаю не слишком зависеть от партнёра.",
    "Я переживаю, что партнёр не так вовлечён в отношения, как я.",
    "Мне сложно полностью открываться партнёру.",
    "Я боюсь быть отвергнутым.",
    "Я чувствую себя скованно, когда партнёр слишком эмоционально близок.",
    "Мне нужно много подтверждений любви.",
    "Я ценю независимость больше, чем близость.",
    "Я переживаю, что партнёр меня оставит.",
    "Мне важно сохранять дистанцию в отношениях.",
    "Я сильно реагирую на признаки охлаждения со стороны партнёра.",
    "Мне сложно полагаться на партнёра.",
    "Я боюсь потерять партнёра.",
    "Я предпочитаю справляться с трудностями самостоятельно.",
    "Мне сложно переносить неопределённость в отношениях.",
    "Я чувствую дискомфорт, когда от меня ожидают эмоциональной близости.",
    "Я не люблю, когда партнёр слишком на меня рассчитывает.",
    "Я часто переживаю из-за отношений.",
    "Мне сложно делиться личными переживаниями.",
    "Я боюсь, что партнёр найдёт кого-то лучше.",
    "Я стараюсь не быть слишком эмоционально вовлечённым.",
    "Я нуждаюсь в постоянной эмоциональной поддержке.",
    "Я избегаю сильной привязанности.",
    "Я тревожусь, если партнёр долго не выходит на связь.",
    "Я чувствую себя неуютно в слишком близких отношениях.",
    "Мне важно сохранять автономию.",
    "Я переживаю, что могу остаться один.",
    "Я стараюсь держать эмоциональную дистанцию.",
    "Я часто сомневаюсь в чувствах партнёра.",
    "Я чувствую напряжение, когда отношения становятся слишком серьёзными.",
    "Мне важно, чтобы партнёр был рядом.",
    "Я избегаю зависимости в отношениях.",
    "Я боюсь эмоциональной потери."
]

# -----------------------------
# ИНДЕКСЫ ШКАЛ
# -----------------------------
ANXIETY_IDX = {0,2,3,5,7,9,11,13,15,17,20,22,24,26,29,31,33,35}
AVOIDANCE_IDX = {1,4,6,8,10,12,14,16,18,19,21,23,25,27,28,30,32,34}

# -----------------------------
# ХРАНЕНИЕ СОСТОЯНИЯ
# -----------------------------
user_answers = {}
user_index = {}

# -----------------------------
# КЛАВИАТУРА ОЦЕНКИ
# -----------------------------
def scale_keyboard():
    kb = InlineKeyboardMarkup(row_width=7)
    for i in range(1, 8):
        kb.insert(InlineKeyboardButton(str(i), callback_data=f"ans_{i}"))
    return kb

ANSWER_TEXT = {
    1: "1 — совсем не про меня",
    2: "2 - в основном не про меня",
    3: "3 — скорее не про меня",
    4: "4 — и да, и нет",
    5: "5 — скорее про меня",
    6: "6 — в основном про меня",
    7: "7 — полностью про меня"
}

# -----------------------------
# ИНТЕРПРЕТАЦИЯ РЕЗУЛЬТАТОВ
# -----------------------------
def interpret_attachment(anxiety, avoidance):
    result = []

    if anxiety <= 41 and avoidance <= 41:
        result.append(
            "Ваш профиль соответствует надёжному стилю привязанности.\n\n"
            "Обычно это означает способность выстраивать близкие отношения без "
            "постоянного страха потери и без выраженного стремления "
            "дистанцироваться от партнёра. Близость и автономия находятся "
            "в устойчивом балансе."
        )

    elif anxiety >= 42 and avoidance <= 41:
        if anxiety <= 83:
            result.append(
                "Ваш профиль соответствует тревожному стилю привязанности "
                "со средней выраженностью.\n\n"
                "Чувствительность к дистанции в отношениях проявляется "
                "ситуативно, усиливаясь в значимых или неопределённых контактах.\n\n"
                "Рекомендация:\n"
                "Полезно развивать навыки эмоциональной саморегуляции и "
                "снижать тревожные интерпретации поведения партнёра."
            )
        else:
            result.append(
                "Ваш профиль соответствует тревожному стилю привязанности "
                "с высокой выраженностью.\n\n"
                "Страх потери, потребность в подтверждении значимости и "
                "напряжение в близости проявляются устойчиво и могут "
                "сильно влиять на отношения.\n\n"
                "Рекомендация:\n"
                "Рекомендуется работа с устойчивыми тревожными реакциями "
                "и формированием внутреннего ощущения безопасности."
            )

    elif anxiety <= 41 and avoidance >= 42:
        if avoidance <= 83:
            result.append(
                "Ваш профиль соответствует избегающему стилю привязанности "
                "со средней выраженностью.\n\n"
                "Стремление к дистанции проявляется выборочно, чаще в "
                "эмоционально насыщенных или конфликтных ситуациях.\n\n"
                "Рекомендация:\n"
                "Полезно отслеживать моменты автоматического ухода от близости "
                "и постепенно расширять допустимую эмоциональную вовлечённость."
            )
        else:
            result.append(
                "Ваш профиль соответствует избегающему стилю привязанности "
                "с высокой выраженностью.\n\n"
                "Эмоциональная дистанция и опора на самостоятельность "
                "являются устойчивыми стратегиями и могут ограничивать "
                "глубину отношений.\n\n"
                "Рекомендация:\n"
                "Рекомендуется работа с допуском близости и осознанием "
                "защитных стратегий избегания."
            )

    else:
        if anxiety <= 83 and avoidance <= 83:
            result.append(
                "Ваш профиль соответствует тревожно-избегающему стилю "
                "привязанности со средней выраженностью.\n\n"
                "Потребность в близости сочетается с напряжением и стремлением "
                "дистанцироваться, что проявляется не во всех, но в значимых "
                "отношениях.\n\n"
                "Рекомендация:\n"
                "Полезно работать с осознанием противоречивых реакций на близость "
                "и снижением эмоциональной нестабильности в контакте."
            )
        else:
            result.append(
                "Ваш профиль соответствует тревожно-избегающему стилю "
                "привязанности с высокой выраженностью.\n\n"
                "Внутренний конфликт между потребностью в близости и страхом "
                "зависимости проявляется устойчиво и часто делает отношения "
                "напряжёнными и нестабильными.\n\n"
                "Рекомендация:\n"
                "Рекомендуется работа со стабилизацией эмоционального состояния "
                "и формированием более предсказуемых стратегий взаимодействия "
                "в отношениях."
            )

    result.append(
        "Если вы хотите разобрать результат и понять, как он проявляется "
        "именно в ваших реальных отношениях, вы можете записаться на "
        "диагностическую консультацию:\n"
        "https://t.me/mserganin"
    )

    return "\n\n".join(result)

# -----------------------------
# СТАРТ
# -----------------------------
@dp.message_handler(commands=["start"])
async def start_handler(message: types.Message):
    uid = message.from_user.id
    user_answers[uid] = []
    user_index[uid] = 0

    desc = "\n".join(ANSWER_TEXT[i] for i in range(1, 8))
    
    # Создаем клавиатуру как отдельный объект
    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton("Начать тест", callback_data="start_test"))

    await message.answer(
        "Это опросник для оценки особенностей привязанности в близких отношениях.\n\n"
        "Вам будут предложены 36 утверждений.\n"
        "Оцените их по шкале от 1 до 7.\n\n"
        f"{desc}",
        reply_markup=kb
    )
@dp.callback_query_handler(lambda c: c.data == "start_test")
async def start_test(call: types.CallbackQuery):
    uid = call.from_user.id
    user_index[uid] = 0
    await call.message.answer(
        f"Вопрос 1 из 36:\n\n{QUESTIONS[0]}",
        reply_markup=scale_keyboard()
    )
    await call.answer()

@dp.callback_query_handler(lambda c: c.data.startswith("ans_"))
async def answer_handler(call: types.CallbackQuery):
    uid = call.from_user.id
    score = int(call.data.split("_")[1])

    user_answers[uid].append(score)
    user_index[uid] += 1

    if user_index[uid] < 36:
        qn = user_index[uid] + 1
        await call.message.answer(
            f"Вопрос {qn} из 36:\n\n{QUESTIONS[user_index[uid]]}",
            reply_markup=scale_keyboard()
        )
    else:
        anxiety = sum(user_answers[uid][i] for i in ANXIETY_IDX)
        avoidance = sum(user_answers[uid][i] for i in AVOIDANCE_IDX)

        text = interpret_attachment(anxiety, avoidance)
        await call.message.answer(text)

    await call.answer()

if __name__ == '__main__':
    port = int(os.environ.get("PORT", 10000))
    from aiohttp import web
    async def on_startup(app):
        import asyncio
        asyncio.create_task(dp.start_polling())
    app.on_startup.append(on_startup)
    web.run_app(app, host='0.0.0.0', port=port)
