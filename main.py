import os
import logging
import asyncio
from datetime import datetime
from aiogram import Bot, Dispatcher, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiohttp import web

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# -----------------------------
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
# -----------------------------
BOT_TOKEN = os.environ.get("BOT_TOKEN")
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ—Ç URL —Ç–æ—á–Ω—ã–π –∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –≤–∞—à–∏–º —Å–µ—Ä–≤–∏—Å–æ–º Render
RENDER_URL = "https://erc-r-bot.onrender.com"
WEBHOOK_PATH = f"/webhook/{BOT_TOKEN}"
WEBHOOK_URL = f"{RENDER_URL}{WEBHOOK_PATH}"

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot)
app = web.Application()

# -----------------------------
# –î–ê–ù–ù–´–ï –¢–ï–°–¢–ê
# -----------------------------
QUESTIONS = [
    "–Ø –±–µ—Å–ø–æ–∫–æ—é—Å—å –æ —Ç–æ–º, —á—Ç–æ –ø–∞—Ä—Ç–Ω—ë—Ä –º–æ–∂–µ—Ç –º–µ–Ω—è —Ä–∞–∑–ª—é–±–∏—Ç—å.",
    "–ú–Ω–µ –Ω–µ–∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ, –∫–æ–≥–¥–∞ –ø–∞—Ä—Ç–Ω—ë—Ä —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–∏–º.",
    "–ú–Ω–µ –≤–∞–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á—É–≤—Å—Ç–≤ –ø–∞—Ä—Ç–Ω—ë—Ä–∞.",
    "–Ø —á–∞—Å—Ç–æ –¥—É–º–∞—é –æ —Ç–æ–º, –Ω–∞—Å–∫–æ–ª—å–∫–æ —è –∑–Ω–∞—á–∏–º –¥–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞.",
    "–Ø –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞—é –Ω–µ —Å–ª–∏—à–∫–æ–º –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞.",
    "–Ø –ø–µ—Ä–µ–∂–∏–≤–∞—é, —á—Ç–æ –ø–∞—Ä—Ç–Ω—ë—Ä –Ω–µ —Ç–∞–∫ –≤–æ–≤–ª–µ—á—ë–Ω –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è, –∫–∞–∫ —è.",
    "–ú–Ω–µ —Å–ª–æ–∂–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è –ø–∞—Ä—Ç–Ω—ë—Ä—É.",
    "–Ø –±–æ—é—Å—å –±—ã—Ç—å –æ—Ç–≤–µ—Ä–≥–Ω—É—Ç—ã–º.",
    "–Ø —á—É–≤—Å—Ç–≤—É—é —Å–µ–±—è —Å–∫–æ–≤–∞–Ω–Ω–æ, –∫–æ–≥–¥–∞ –ø–∞—Ä—Ç–Ω—ë—Ä —Å–ª–∏—à–∫–æ–º —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –±–ª–∏–∑–æ–∫.",
    "–ú–Ω–µ –Ω—É–∂–Ω–æ –º–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –ª—é–±–≤–∏.",
    "–Ø —Ü–µ–Ω—é –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –±–æ–ª—å—à–µ, —á–µ–º –±–ª–∏–∑–æ—Å—Ç—å.",
    "–Ø –ø–µ—Ä–µ–∂–∏–≤–∞—é, —á—Ç–æ –ø–∞—Ä—Ç–Ω—ë—Ä –º–µ–Ω—è –æ—Å—Ç–∞–≤–∏—Ç.",
    "–ú–Ω–µ –≤–∞–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–∏—Å—Ç–∞–Ω—Ü–∏—é –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.",
    "–Ø —Å–∏–ª—å–Ω–æ —Ä–µ–∞–≥–∏—Ä—É—é –Ω–∞ –ø—Ä–∏–∑–Ω–∞–∫–∏ –æ—Ö–ª–∞–∂–¥–µ–Ω–∏—è —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –ø–∞—Ä—Ç–Ω—ë—Ä–∞.",
    "–ú–Ω–µ —Å–ª–æ–∂–Ω–æ –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ –ø–∞—Ä—Ç–Ω—ë—Ä–∞.",
    "–Ø –±–æ—é—Å—å –ø–æ—Ç–µ—Ä—è—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä–∞.",
    "–Ø –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞—é —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å —Ç—Ä—É–¥–Ω–æ—Å—Ç—è–º–∏ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ.",
    "–ú–Ω–µ —Å–ª–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç—å –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.",
    "–Ø —á—É–≤—Å—Ç–≤—É—é –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç, –∫–æ–≥–¥–∞ –æ—Ç –º–µ–Ω—è –æ–∂–∏–¥–∞—é—Ç —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –±–ª–∏–∑–æ—Å—Ç–∏.",
    "–Ø –Ω–µ –ª—é–±–ª—é, –∫–æ–≥–¥–∞ –ø–∞—Ä—Ç–Ω—ë—Ä —Å–ª–∏—à–∫–æ–º –Ω–∞ –º–µ–Ω—è —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç.",
    "–Ø —á–∞—Å—Ç–æ –ø–µ—Ä–µ–∂–∏–≤–∞—é –∏–∑-–∑–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏–π.",
    "–ú–Ω–µ —Å–ª–æ–∂–Ω–æ –¥–µ–ª–∏—Ç—å—Å—è –ª–∏—á–Ω—ã–º–∏ –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏—è–º–∏.",
    "–Ø –±–æ—é—Å—å, —á—Ç–æ –ø–∞—Ä—Ç–Ω—ë—Ä –Ω–∞–π–¥—ë—Ç –∫–æ–≥–æ-—Ç–æ –ª—É—á—à–µ.",
    "–Ø —Å—Ç–∞—Ä–∞—é—Å—å –Ω–µ –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –≤–æ–≤–ª–µ—á—ë–Ω–Ω—ã–º.",
    "–Ø –Ω—É–∂–¥–∞—é—Å—å –≤ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–µ.",
    "–Ø –∏–∑–±–µ–≥–∞—é —Å–∏–ª—å–Ω–æ–π –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏.",
    "–Ø —Ç—Ä–µ–≤–æ–∂—É—Å—å, –µ—Å–ª–∏ –ø–∞—Ä—Ç–Ω—ë—Ä –¥–æ–ª–≥–æ –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –Ω–∞ —Å–≤—è–∑—å.",
    "–Ø —á—É–≤—Å—Ç–≤—É—é —Å–µ–±—è –Ω–µ—É—é—Ç–Ω–æ –≤ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.",
    "–ú–Ω–µ –≤–∞–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∞–≤—Ç–æ–Ω–æ–º–∏—é.",
    "–Ø –ø–µ—Ä–µ–∂–∏–≤–∞—é, —á—Ç–æ –º–æ–≥—É –æ—Å—Ç–∞—Ç—å—Å—è –æ–¥–∏–Ω.",
    "–Ø —Å—Ç–∞—Ä–∞—é—Å—å –¥–µ—Ä–∂–∞—Ç—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –¥–∏—Å—Ç–∞–Ω—Ü–∏—é.",
    "–Ø —á–∞—Å—Ç–æ —Å–æ–º–Ω–µ–≤–∞—é—Å—å –≤ —á—É–≤—Å—Ç–≤–∞—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–∞.",
    "–Ø —á—É–≤—Å—Ç–≤—É—é –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ, –∫–æ–≥–¥–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —Å–ª–∏—à–∫–æ–º —Å–µ—Ä—å—ë–∑–Ω—ã–º–∏.",
    "–ú–Ω–µ –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –ø–∞—Ä—Ç–Ω—ë—Ä –±—ã–ª —Ä—è–¥–æ–º.",
    "–Ø –∏–∑–±–µ–≥–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.",
    "–Ø –±–æ—é—Å—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –ø–æ—Ç–µ—Ä–∏."
]

# –ò–Ω–¥–µ–∫—Å—ã —à–∫–∞–ª
ANXIETY_IDX = {0,2,3,5,7,9,11,13,15,17,20,22,24,26,29,31,33,35}
AVOIDANCE_IDX = {1,4,6,8,10,12,14,16,18,19,21,23,25,27,28,30,32,34}

# –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
user_answers = {}
user_index = {}

# -----------------------------
# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
# -----------------------------
def scale_keyboard(show_back=False):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –æ—Ü–µ–Ω–∫–∞–º–∏ 1-7 –∏ –∫–Ω–æ–ø–∫–æ–π –ù–∞–∑–∞–¥"""
    kb = InlineKeyboardMarkup(row_width=7)
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ 1-7
    buttons = [InlineKeyboardButton(str(i), callback_data=f"ans_{i}") for i in range(1, 8)]
    kb.add(*buttons)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ù–∞–∑–∞–¥, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if show_back:
        kb.row(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back"))
    return kb

def interpret_attachment(anxiety, avoidance):
    """–õ–æ–≥–∏–∫–∞ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"""
    result_text = ""

    # 1. –ù–ê–î–Å–ñ–ù–´–ô
    if anxiety <= 41 and avoidance <= 41:
        result_text = (
            "–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞–¥—ë–∂–Ω–æ–º—É —Å—Ç–∏–ª—é –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏.\n\n"
            "–û–±—ã—á–Ω–æ —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤—ã—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –±–ª–∏–∑–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –±–µ–∑ "
            "–ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Å—Ç—Ä–∞—Ö–∞ –ø–æ—Ç–µ—Ä–∏ –∏ –±–µ–∑ –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ–≥–æ —Å—Ç—Ä–µ–º–ª–µ–Ω–∏—è "
            "–¥–∏—Å—Ç–∞–Ω—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è –æ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞. –ë–ª–∏–∑–æ—Å—Ç—å –∏ –∞–≤—Ç–æ–Ω–æ–º–∏—è –Ω–∞—Ö–æ–¥—è—Ç—Å—è "
            "–≤ —É—Å—Ç–æ–π—á–∏–≤–æ–º –±–∞–ª–∞–Ω—Å–µ."
        )

    # 2 –∏ 3. –¢–†–ï–í–û–ñ–ù–´–ô (–ø—Ä–∏ –Ω–∏–∑–∫–æ–º –∏–∑–±–µ–≥–∞–Ω–∏–∏)
    elif avoidance <= 41: 
        if 42 <= anxiety <= 83:
            result_text = (
                "–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–≤–æ–∂–Ω–æ–º—É —Å—Ç–∏–ª—é –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ "
                "—Å–æ —Å—Ä–µ–¥–Ω–µ–π –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç—å—é.\n\n"
                "–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è "
                "—Å–∏—Ç—É–∞—Ç–∏–≤–Ω–æ, —É—Å–∏–ª–∏–≤–∞—è—Å—å –≤ –∑–Ω–∞—á–∏–º—ã—Ö –∏–ª–∏ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö.\n\n"
                "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:\n"
                "–ü–æ–ª–µ–∑–Ω–æ —Ä–∞–∑–≤–∏–≤–∞—Ç—å –Ω–∞–≤—ã–∫–∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π —Å–∞–º–æ—Ä–µ–≥—É–ª—è—Ü–∏–∏ –∏ "
                "—Å–Ω–∏–∂–∞—Ç—å —Ç—Ä–µ–≤–æ–∂–Ω—ã–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞."
            )
        else: # anxiety >= 84
            result_text = (
                "–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–≤–æ–∂–Ω–æ–º—É —Å—Ç–∏–ª—é –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ "
                "—Å –≤—ã—Å–æ–∫–æ–π –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç—å—é.\n\n"
                "–°—Ç—Ä–∞—Ö –ø–æ—Ç–µ—Ä–∏, –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏ –∏ "
                "–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –≤ –±–ª–∏–∑–æ—Å—Ç–∏ –ø—Ä–æ—è–≤–ª—è—é—Ç—Å—è —É—Å—Ç–æ–π—á–∏–≤–æ –∏ –º–æ–≥—É—Ç "
                "—Å–∏–ª—å–Ω–æ –≤–ª–∏—è—Ç—å –Ω–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏—è.\n\n"
                "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:\n"
                "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–∞–±–æ—Ç–∞ —Å —É—Å—Ç–æ–π—á–∏–≤—ã–º–∏ —Ç—Ä–µ–≤–æ–∂–Ω—ã–º–∏ —Ä–µ–∞–∫—Ü–∏—è–º–∏ "
                "–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –æ—â—É—â–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏."
            )

    # 4 –∏ 5. –ò–ó–ë–ï–ì–ê–Æ–©–ò–ô (–ø—Ä–∏ –Ω–∏–∑–∫–æ–π —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç–∏)
    elif anxiety <= 41:
        if 42 <= avoidance <= 83:
            result_text = (
                "–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏–∑–±–µ–≥–∞—é—â–µ–º—É —Å—Ç–∏–ª—é –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ "
                "—Å–æ —Å—Ä–µ–¥–Ω–µ–π –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç—å—é.\n\n"
                "–°—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤—ã–±–æ—Ä–æ—á–Ω–æ, —á–∞—â–µ –≤ "
                "—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã—Ö –∏–ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö.\n\n"
                "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:\n"
                "–ü–æ–ª–µ–∑–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –º–æ–º–µ–Ω—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É—Ö–æ–¥–∞ –æ—Ç –±–ª–∏–∑–æ—Å—Ç–∏ "
                "–∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å –¥–æ–ø—É—Å—Ç–∏–º—É—é —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å."
            )
        else: # avoidance >= 84
            result_text = (
                "–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏–∑–±–µ–≥–∞—é—â–µ–º—É —Å—Ç–∏–ª—é –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ "
                "—Å –≤—ã—Å–æ–∫–æ–π –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç—å—é.\n\n"
                "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è –∏ –æ–ø–æ—Ä–∞ –Ω–∞ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å "
                "—è–≤–ª—è—é—Ç—Å—è —É—Å—Ç–æ–π—á–∏–≤—ã–º–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏ –∏ –º–æ–≥—É—Ç –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å "
                "–≥–ª—É–±–∏–Ω—É –æ—Ç–Ω–æ—à–µ–Ω–∏–π.\n\n"
                "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:\n"
                "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–∞–±–æ—Ç–∞ —Å –¥–æ–ø—É—Å–∫–æ–º –±–ª–∏–∑–æ—Å—Ç–∏ –∏ –æ—Å–æ–∑–Ω–∞–Ω–∏–µ–º "
                "–∑–∞—â–∏—Ç–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –∏–∑–±–µ–≥–∞–Ω–∏—è."
            )

    # 6 –∏ 7. –¢–†–ï–í–û–ñ–ù–û-–ò–ó–ë–ï–ì–ê–Æ–©–ò–ô (–°–º–µ—à–∞–Ω–Ω—ã–π —Ç–∏–ø)
    else:
        # –ï—Å–ª–∏ –æ–±–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –≤ —Å—Ä–µ–¥–Ω–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
        if anxiety <= 83 and avoidance <= 83:
            result_text = (
                "–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–≤–æ–∂–Ω–æ-–∏–∑–±–µ–≥–∞—é—â–µ–º—É —Å—Ç–∏–ª—é "
                "–ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ —Å–æ —Å—Ä–µ–¥–Ω–µ–π –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç—å—é.\n\n"
                "–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –±–ª–∏–∑–æ—Å—Ç–∏ —Å–æ—á–µ—Ç–∞–µ—Ç—Å—è —Å –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ–º –∏ —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ–º "
                "–¥–∏—Å—Ç–∞–Ω—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è, —á—Ç–æ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–µ –≤–æ –≤—Å–µ—Ö, –Ω–æ –≤ –∑–Ω–∞—á–∏–º—ã—Ö "
                "–æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.\n\n"
                "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:\n"
                "–ü–æ–ª–µ–∑–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –æ—Å–æ–∑–Ω–∞–Ω–∏–µ–º –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã—Ö —Ä–µ–∞–∫—Ü–∏–π –Ω–∞ –±–ª–∏–∑–æ—Å—Ç—å "
                "–∏ —Å–Ω–∏–∂–µ–Ω–∏–µ–º —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Ç–∞–∫—Ç–µ."
            )
        else:
            # –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä –≤—ã—Å–æ–∫–∏–π (>= 84), –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º –≤—Ç–æ—Ä–æ–π —Ç–æ–∂–µ > 41
            result_text = (
                "–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–≤–æ–∂–Ω–æ-–∏–∑–±–µ–≥–∞—é—â–µ–º—É —Å—Ç–∏–ª—é "
                "–ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ —Å –≤—ã—Å–æ–∫–æ–π –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç—å—é.\n\n"
                "–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç –º–µ–∂–¥—É –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å—é –≤ –±–ª–∏–∑–æ—Å—Ç–∏ –∏ —Å—Ç—Ä–∞—Ö–æ–º "
                "–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è —É—Å—Ç–æ–π—á–∏–≤–æ –∏ —á–∞—Å—Ç–æ –¥–µ–ª–∞–µ—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏—è "
                "–Ω–∞–ø—Ä—è–∂—ë–Ω–Ω—ã–º–∏ –∏ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–º–∏.\n\n"
                "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:\n"
                "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–∞–±–æ—Ç–∞ —Å–æ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–µ–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è "
                "–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –±–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è "
                "–≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö."
            )

    footer = (
        "–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–æ–±—Ä–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –ø–æ–Ω—è—Ç—å,"
        "–∫–∞–∫ –æ–Ω –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –∏–º–µ–Ω–Ω–æ –≤ –≤–∞—à–∏—Ö —Ä–µ–∞–ª—å–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö - "
        "–Ω–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞ –∏ –≤–∞—à –≤–æ–ø—Ä–æ—Å:\n"
        "https://t.me/mserganin"
    )
    
    return f"{result_text}\n\n{footer}"

# -----------------------------
# –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò TELEGRAM
# -----------------------------

@dp.message_handler(commands=["start"])
async def start_handler(message: types.Message):
    uid = message.from_user.id
    # –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç–µ—Å—Ç–∞
    user_answers[uid] = []
    user_index[uid] = 0

    welcome_text = (
        "üìã *–û–ø—Ä–æ—Å–Ω–∏–∫ —Å—Ç–∏–ª–µ–π –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏*\n\n"
        "üìå *–ß—Ç–æ —Ç–∞–∫–æ–µ —Å—Ç–∏–ª—å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏?*\n"
        "–≠—Ç–æ —É—Å—Ç–æ–π—á–∏–≤—ã–π —Å–ø–æ—Å–æ–± –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–≤—è–∑–µ–π –≤ –ø–∞—Ä–µ, —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤ –¥–µ—Ç—Å—Ç–≤–µ "
        "–∏ –≤–ª–∏—è—é—â–∏–π –Ω–∞ –≤—Å–µ –±–ª–∏–∑–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –≤–æ –≤–∑—Ä–æ—Å–ª–æ–π –∂–∏–∑–Ω–∏.\n\n"
        "üìå *–ß—Ç–æ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ç–µ—Å—Ç?*\n"
        "‚Ä¢ –£—Ä–æ–≤–µ–Ω—å —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç–∏ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö\n"
        "‚Ä¢ –°–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º—É –∏–∑–±–µ–≥–∞–Ω–∏—é\n\n"
        "üìå *–ß—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ?*\n"
        "1. –ß–∏—Å–ª–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ —à–∫–∞–ª–∞–º —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç–∏ –∏ –∏–∑–±–µ–≥–∞–Ω–∏—è\n"
        "2. –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è\n"
        "3. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –æ—Ç–Ω–æ—à–µ–Ω–∏–π –∏—Å—Ö–æ–¥—è –∏–∑ –≤–∞—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤\n"
        "4. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –¥–∏–Ω–∞–º–∏–∫—É. –î–ª—è —ç—Ç–æ–≥–æ —Å–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –≤–∞—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.\n\n"
        "üîí *–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:* –í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ "
        "–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º.\n\n"
        "üïê –¢–µ—Å—Ç –∑–∞–π–º–µ—Ç 5-7 –º–∏–Ω—É—Ç\n"
        "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è\n\n"
        "üéØ *–ö–∞–∫ –ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç:*\n\n"
        "–í–∞–º –±—É–¥–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ –ø–æ –æ–¥–Ω–æ–º—É 36 —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π.\n"
        "–û—Ü–µ–Ω–∏—Ç–µ, –Ω–∞—Å–∫–æ–ª—å–∫–æ –∫–∞–∂–¥–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –≤–∞—Å –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.\n"
        "–ó–¥–µ—Å—å –Ω–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤.\n"
        "–û—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –≤–∞—à–∏ —á—É–≤—Å—Ç–≤–∞, –∞ –Ω–µ –Ω–∞ '–∫–∞–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å'.\n"
        "–í—Å–ø–æ–º–∏–Ω–∞–π—Ç–µ –≤–∞—à–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–Ω–∞—á–∏–º—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è.\n"
        "–í—ã–±–µ—Ä–µ—Ç–µ –æ–¥–Ω—É –∏–∑ —Å–µ–º–∏ –æ—Ü–µ–Ω–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π.\n\n"
        "üìù *–®–∫–∞–ª–∞ –æ—Ü–µ–Ω–∫–∏:*\n\n"
        "1Ô∏è‚É£ ‚Äî –°–æ–≤—Å–µ–º –Ω–µ –ø—Ä–æ –º–µ–Ω—è\n"
        "2Ô∏è‚É£ ‚Äî –í –æ—Å–Ω–æ–≤–Ω–æ–º –Ω–µ –ø—Ä–æ –º–µ–Ω—è\n"
        "3Ô∏è‚É£ ‚Äî –°–∫–æ—Ä–µ–µ –Ω–µ—Ç\n"
        "4Ô∏è‚É£ ‚Äî –ò –¥–∞, –∏ –Ω–µ—Ç\n"
        "5Ô∏è‚É£ ‚Äî –°–∫–æ—Ä–µ–µ –¥–∞\n"
        "6Ô∏è‚É£ ‚Äî –í –æ—Å–Ω–æ–≤–Ω–æ–º –ø—Ä–æ –º–µ–Ω—è\n"
        "7Ô∏è‚É£ ‚Äî –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ –º–µ–Ω—è\n\n"
        "–ì–æ—Ç–æ–≤—ã?"
    )
    
    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton("–ù–∞—á–∞—Ç—å", callback_data="start_test"))

    await message.answer(welcome_text, parse_mode="Markdown", reply_markup=kb)

@dp.callback_query_handler(lambda c: c.data == "start_test")
async def start_test(call: types.CallbackQuery):
    uid = call.from_user.id
    user_index[uid] = 0
    user_answers[uid] = []
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
    await call.message.edit_text(
        f"–í–æ–ø—Ä–æ—Å 1 –∏–∑ 36:\n\n{QUESTIONS[0]}", 
        reply_markup=scale_keyboard(show_back=False)
    )
    await call.answer()

@dp.callback_query_handler(lambda c: c.data == "back")
async def back_handler(call: types.CallbackQuery):
    uid = call.from_user.id
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫—É–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è
    if uid in user_index and user_index[uid] > 0:
        user_index[uid] -= 1
        user_answers[uid].pop() # –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç
        
        qn = user_index[uid]
        await call.message.edit_text(
            f"–í–æ–ø—Ä–æ—Å {qn + 1} –∏–∑ 36:\n\n{QUESTIONS[qn]}", 
            reply_markup=scale_keyboard(show_back=(qn > 0))
        )
    await call.answer()

@dp.callback_query_handler(lambda c: c.data.startswith("ans_"))
async def answer_handler(call: types.CallbackQuery):
    uid = call.from_user.id
    if uid not in user_answers: 
        user_answers[uid] = []
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç
    score = int(call.data.split("_")[1])
    user_answers[uid].append(score)
    user_index[uid] += 1

    if user_index[uid] < 36:
        # –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
        qn = user_index[uid]
        await call.message.edit_text(
            f"–í–æ–ø—Ä–æ—Å {qn + 1} –∏–∑ 36:\n\n{QUESTIONS[qn]}", 
            reply_markup=scale_keyboard(show_back=True)
        )
    else:
        # –ü–æ–¥—Å—á–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        anxiety = sum(user_answers[uid][i] for i in ANXIETY_IDX)
        avoidance = sum(user_answers[uid][i] for i in AVOIDANCE_IDX)
        
        interpretation = interpret_attachment(anxiety, avoidance)
        date_str = datetime.now().strftime("%d.%m.%Y")
        
        result_message = (
            f"üìÖ –î–∞—Ç–∞ –æ–ø—Ä–æ—Å–∞: {date_str}\n"
            f"üìä *–í–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:*\n\n"
            f"üîπ *–¢—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å:* {anxiety}/126\n"
            f"üîπ *–ò–∑–±–µ–≥–∞–Ω–∏–µ:* {avoidance}/126\n\n"
            f"{interpretation}"
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
        await call.message.answer(result_message, parse_mode="Markdown", disable_web_page_preview=False)
        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–æ–ø—Ä–æ—Å–æ–º
        await call.message.delete()
        
        # –£–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ø–∞–º—è—Ç–∏
        user_answers.pop(uid, None)
        user_index.pop(uid, None)
        
    await call.answer()

# -----------------------------
# –í–ï–ë–•–£–ö–ò –ò –°–ï–†–í–ï–† (–î–ª—è Render)
# -----------------------------
async def handle_webhook(request):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram"""
    try:
        data = await request.json()
        update = types.Update(**data)
        
        # –ö–†–ò–¢–ò–ß–ù–û –í–ê–ñ–ù–û: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –±–æ—Ç–∞
        Bot.set_current(bot)
        
        await dp.process_update(update)
        return web.Response(text="OK")
    except Exception as e:
        logger.error(f"Webhook error: {e}")
        return web.Response(status=500)

async def on_startup(app):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ"""
    await bot.delete_webhook(drop_pending_updates=True)
    await bot.set_webhook(WEBHOOK_URL)
    logger.info(f"‚úÖ –í–µ–±—Ö—É–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {WEBHOOK_URL}")

async def on_shutdown(app):
    """–û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏"""
    await bot.delete_webhook()
    await dp.storage.close()
    await dp.storage.wait_closed()
    logger.info("üõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

# -----------------------------
# –ó–ê–ü–£–°–ö
# -----------------------------
app.router.add_get('/', lambda r: web.Response(text="Bot is alive!"))
app.router.add_post(f'/webhook/{BOT_TOKEN}', handle_webhook)
app.on_startup.append(on_startup)
app.on_shutdown.append(on_shutdown)

if __name__ == '__main__':
    port = int(os.environ.get("PORT", 10000))
    logger.info(f"üöÄ –ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É {port}")
    web.run_app(app, host='0.0.0.0', port=port, handle_signals=False)
