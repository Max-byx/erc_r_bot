import os
import logging
import asyncio
from aiogram import Bot, Dispatcher, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiohttp import web

logging.basicConfig(level=logging.INFO)

BOT_TOKEN = os.environ.get("BOT_TOKEN")
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot)

async def handle(request):
    return web.Response(text="Bot is alive!")

app = web.Application()
app.router.add_get('/', handle)
# ----------------------------------------
QUESTIONS = [
    "–Ø –±–µ—Å–ø–æ–∫–æ—é—Å—å –æ —Ç–æ–º, —á—Ç–æ –ø–∞—Ä—Ç–Ω—ë—Ä –º–æ–∂–µ—Ç –º–µ–Ω—è —Ä–∞–∑–ª—é–±–∏—Ç—å.",
    "–ú–Ω–µ –Ω–µ–∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ, –∫–æ–≥–¥–∞ –ø–∞—Ä—Ç–Ω—ë—Ä —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–∏–º.",
    "–ú–Ω–µ –≤–∞–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á—É–≤—Å—Ç–≤ –ø–∞—Ä—Ç–Ω—ë—Ä–∞.",
    "–Ø —á–∞—Å—Ç–æ –¥—É–º–∞—é –æ —Ç–æ–º, –Ω–∞—Å–∫–æ–ª—å–∫–æ —è –∑–Ω–∞—á–∏–º –¥–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞.",
    "–Ø –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞—é –Ω–µ —Å–ª–∏—à–∫–æ–º –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞.",
    "–Ø –ø–µ—Ä–µ–∂–∏–≤–∞—é, —á—Ç–æ –ø–∞—Ä—Ç–Ω—ë—Ä –Ω–µ —Ç–∞–∫ –≤–æ–≤–ª–µ—á—ë–Ω –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è, –∫–∞–∫ —è.",
    "–ú–Ω–µ —Å–ª–æ–∂–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è –ø–∞—Ä—Ç–Ω—ë—Ä—É.",
    "–Ø –±–æ—é—Å—å –±—ã—Ç—å –æ—Ç–≤–µ—Ä–≥–Ω—É—Ç—ã–º.",
    "–Ø —á—É–≤—Å—Ç–≤—É—é —Å–µ–±—è —Å–∫–æ–≤–∞–Ω–Ω–æ, –∫–æ–≥–¥–∞ –ø–∞—Ä—Ç–Ω—ë—Ä —Å–ª–∏—à–∫–æ–º —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –±–ª–∏–∑–æ–∫.",
    "–ú–Ω–µ –Ω—É–∂–Ω–æ –º–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –ª—é–±–≤–∏.",
    "–Ø —Ü–µ–Ω—é –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –±–æ–ª—å—à–µ, —á–µ–º –±–ª–∏–∑–æ—Å—Ç—å.",
    "–Ø –ø–µ—Ä–µ–∂–∏–≤–∞—é, —á—Ç–æ –ø–∞—Ä—Ç–Ω—ë—Ä –º–µ–Ω—è –æ—Å—Ç–∞–≤–∏—Ç.",
    "–ú–Ω–µ –≤–∞–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–∏—Å—Ç–∞–Ω—Ü–∏—é –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.",
    "–Ø —Å–∏–ª—å–Ω–æ —Ä–µ–∞–≥–∏—Ä—É—é –Ω–∞ –ø—Ä–∏–∑–Ω–∞–∫–∏ –æ—Ö–ª–∞–∂–¥–µ–Ω–∏—è —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –ø–∞—Ä—Ç–Ω—ë—Ä–∞.",
    "–ú–Ω–µ —Å–ª–æ–∂–Ω–æ –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ –ø–∞—Ä—Ç–Ω—ë—Ä–∞.",
    "–Ø –±–æ—é—Å—å –ø–æ—Ç–µ—Ä—è—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä–∞.",
    "–Ø –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞—é —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å —Ç—Ä—É–¥–Ω–æ—Å—Ç—è–º–∏ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ.",
    "–ú–Ω–µ —Å–ª–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç—å –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.",
    "–Ø —á—É–≤—Å—Ç–≤—É—é –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç, –∫–æ–≥–¥–∞ –æ—Ç –º–µ–Ω—è –æ–∂–∏–¥–∞—é—Ç —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –±–ª–∏–∑–æ—Å—Ç–∏.",
    "–Ø –Ω–µ –ª—é–±–ª—é, –∫–æ–≥–¥–∞ –ø–∞—Ä—Ç–Ω—ë—Ä —Å–ª–∏—à–∫–æ–º –Ω–∞ –º–µ–Ω—è —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç.",
    "–Ø —á–∞—Å—Ç–æ –ø–µ—Ä–µ–∂–∏–≤–∞—é –∏–∑-–∑–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏–π.",
    "–ú–Ω–µ —Å–ª–æ–∂–Ω–æ –¥–µ–ª–∏—Ç—å—Å—è –ª–∏—á–Ω—ã–º–∏ –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏—è–º–∏.",
    "–Ø –±–æ—é—Å—å, —á—Ç–æ –ø–∞—Ä—Ç–Ω—ë—Ä –Ω–∞–π–¥—ë—Ç –∫–æ–≥–æ-—Ç–æ –ª—É—á—à–µ.",
    "–Ø —Å—Ç–∞—Ä–∞—é—Å—å –Ω–µ –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –≤–æ–≤–ª–µ—á—ë–Ω–Ω—ã–º.",
    "–Ø –Ω—É–∂–¥–∞—é—Å—å –≤ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–µ.",
    "–Ø –∏–∑–±–µ–≥–∞—é —Å–∏–ª—å–Ω–æ–π –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏.",
    "–Ø —Ç—Ä–µ–≤–æ–∂—É—Å—å, –µ—Å–ª–∏ –ø–∞—Ä—Ç–Ω—ë—Ä –¥–æ–ª–≥–æ –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –Ω–∞ —Å–≤—è–∑—å.",
    "–Ø —á—É–≤—Å—Ç–≤—É—é —Å–µ–±—è –Ω–µ—É—é—Ç–Ω–æ –≤ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.",
    "–ú–Ω–µ –≤–∞–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∞–≤—Ç–æ–Ω–æ–º–∏—é.",
    "–Ø –ø–µ—Ä–µ–∂–∏–≤–∞—é, —á—Ç–æ –º–æ–≥—É –æ—Å—Ç–∞—Ç—å—Å—è –æ–¥–∏–Ω.",
    "–Ø —Å—Ç–∞—Ä–∞—é—Å—å –¥–µ—Ä–∂–∞—Ç—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –¥–∏—Å—Ç–∞–Ω—Ü–∏—é.",
    "–Ø —á–∞—Å—Ç–æ —Å–æ–º–Ω–µ–≤–∞—é—Å—å –≤ —á—É–≤—Å—Ç–≤–∞—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–∞.",
    "–Ø —á—É–≤—Å—Ç–≤—É—é –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ, –∫–æ–≥–¥–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —Å–ª–∏—à–∫–æ–º —Å–µ—Ä—å—ë–∑–Ω—ã–º–∏.",
    "–ú–Ω–µ –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –ø–∞—Ä—Ç–Ω—ë—Ä –±—ã–ª —Ä—è–¥–æ–º.",
    "–Ø –∏–∑–±–µ–≥–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.",
    "–Ø –±–æ—é—Å—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –ø–æ—Ç–µ—Ä–∏."
]

# -----------------------------
# –ò–ù–î–ï–ö–°–´ –®–ö–ê–õ
# -----------------------------
ANXIETY_IDX = {0,2,3,5,7,9,11,13,15,17,20,22,24,26,29,31,33,35}
AVOIDANCE_IDX = {1,4,6,8,10,12,14,16,18,19,21,23,25,27,28,30,32,34}

# -----------------------------
# –•–†–ê–ù–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–Ø
# -----------------------------
user_answers = {}
user_index = {}

# -----------------------------
# –ö–õ–ê–í–ò–ê–¢–£–†–ê –û–¶–ï–ù–ö–ò
# -----------------------------
def scale_keyboard():
    kb = InlineKeyboardMarkup(row_width=7)
    for i in range(1, 8):
        kb.insert(InlineKeyboardButton(str(i), callback_data=f"ans_{i}"))
    return kb

ANSWER_TEXT = {
    1: "1 ‚Äî —Å–æ–≤—Å–µ–º –Ω–µ –ø—Ä–æ –º–µ–Ω—è",
    2: "2 ‚Äî –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –Ω–µ –ø—Ä–æ –º–µ–Ω—è",
    3: "3 ‚Äî —Å–∫–æ—Ä–µ–µ –Ω–µ –ø—Ä–æ –º–µ–Ω—è",
    4: "4 ‚Äî –∏ –¥–∞, –∏ –Ω–µ—Ç",
    5: "5 ‚Äî —Å–∫–æ—Ä–µ–µ –ø—Ä–æ –º–µ–Ω—è",
    6: "6 ‚Äî –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø—Ä–æ –º–µ–Ω—è",
    7: "7 ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ –º–µ–Ω—è"
}

# -----------------------------
# –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–û–í
# -----------------------------
def interpret_attachment(anxiety, avoidance):
    result = []

    if anxiety <= 41 and avoidance <= 41:
        result.append(
            "–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞–¥—ë–∂–Ω–æ–º—É —Å—Ç–∏–ª—é –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏.\n\n"
            "–û–±—ã—á–Ω–æ —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤—ã—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –±–ª–∏–∑–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –±–µ–∑ "
            "–ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Å—Ç—Ä–∞—Ö–∞ –ø–æ—Ç–µ—Ä–∏ –∏ –±–µ–∑ –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ–≥–æ —Å—Ç—Ä–µ–º–ª–µ–Ω–∏—è "
            "–¥–∏—Å—Ç–∞–Ω—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è –æ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞. –ë–ª–∏–∑–æ—Å—Ç—å –∏ –∞–≤—Ç–æ–Ω–æ–º–∏—è –Ω–∞—Ö–æ–¥—è—Ç—Å—è "
            "–≤ —É—Å—Ç–æ–π—á–∏–≤–æ–º –±–∞–ª–∞–Ω—Å–µ."
        )

    elif anxiety >= 42 and avoidance <= 41:
        if anxiety <= 83:
            result.append(
                "–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–≤–æ–∂–Ω–æ–º—É —Å—Ç–∏–ª—é –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ "
                "—Å–æ —Å—Ä–µ–¥–Ω–µ–π –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç—å—é.\n\n"
                "–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è "
                "—Å–∏—Ç—É–∞—Ç–∏–≤–Ω–æ, —É—Å–∏–ª–∏–≤–∞—è—Å—å –≤ –∑–Ω–∞—á–∏–º—ã—Ö –∏–ª–∏ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö.\n\n"
                "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:\n"
                "–ü–æ–ª–µ–∑–Ω–æ —Ä–∞–∑–≤–∏–≤–∞—Ç—å –Ω–∞–≤—ã–∫–∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π —Å–∞–º–æ—Ä–µ–≥—É–ª—è—Ü–∏–∏ –∏ "
                "—Å–Ω–∏–∂–∞—Ç—å —Ç—Ä–µ–≤–æ–∂–Ω—ã–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞."
            )
        else:
            result.append(
                "–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–≤–æ–∂–Ω–æ–º—É —Å—Ç–∏–ª—é –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ "
                "—Å –≤—ã—Å–æ–∫–æ–π –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç—å—é.\n\n"
                "–°—Ç—Ä–∞—Ö –ø–æ—Ç–µ—Ä–∏, –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏ –∏ "
                "–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –≤ –±–ª–∏–∑–æ—Å—Ç–∏ –ø—Ä–æ—è–≤–ª—è—é—Ç—Å—è —É—Å—Ç–æ–π—á–∏–≤–æ –∏ –º–æ–≥—É—Ç "
                "—Å–∏–ª—å–Ω–æ –≤–ª–∏—è—Ç—å –Ω–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏—è.\n\n"
                "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:\n"
                "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–∞–±–æ—Ç–∞ —Å —É—Å—Ç–æ–π—á–∏–≤—ã–º–∏ —Ç—Ä–µ–≤–æ–∂–Ω—ã–º–∏ —Ä–µ–∞–∫—Ü–∏—è–º–∏ "
                "–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –æ—â—É—â–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏."
            )

    elif anxiety <= 41 and avoidance >= 42:
        if avoidance <= 83:
            result.append(
                "–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏–∑–±–µ–≥–∞—é—â–µ–º—É —Å—Ç–∏–ª—é –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ "
                "—Å–æ —Å—Ä–µ–¥–Ω–µ–π –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç—å—é.\n\n"
                "–°—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤—ã–±–æ—Ä–æ—á–Ω–æ, —á–∞—â–µ –≤ "
                "—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã—Ö –∏–ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö.\n\n"
                "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:\n"
                "–ü–æ–ª–µ–∑–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –º–æ–º–µ–Ω—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É—Ö–æ–¥–∞ –æ—Ç –±–ª–∏–∑–æ—Å—Ç–∏ "
                "–∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å –¥–æ–ø—É—Å—Ç–∏–º—É—é —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å."
            )
        else:
            result.append(
                "–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏–∑–±–µ–≥–∞—é—â–µ–º—É —Å—Ç–∏–ª—é –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ "
                "—Å –≤—ã—Å–æ–∫–æ–π –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç—å—é.\n\n"
                "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è –∏ –æ–ø–æ—Ä–∞ –Ω–∞ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å "
                "—è–≤–ª—è—é—Ç—Å—è —É—Å—Ç–æ–π—á–∏–≤—ã–º–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏ –∏ –º–æ–≥—É—Ç –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å "
                "–≥–ª—É–±–∏–Ω—É –æ—Ç–Ω–æ—à–µ–Ω–∏–π.\n\n"
                "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:\n"
                "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–∞–±–æ—Ç–∞ —Å –¥–æ–ø—É—Å–∫–æ–º –±–ª–∏–∑–æ—Å—Ç–∏ –∏ –æ—Å–æ–∑–Ω–∞–Ω–∏–µ–º "
                "–∑–∞—â–∏—Ç–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –∏–∑–±–µ–≥–∞–Ω–∏—è."
            )

    else:
        if anxiety <= 83 and avoidance <= 83:
            result.append(
                "–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–≤–æ–∂–Ω–æ-–∏–∑–±–µ–≥–∞—é—â–µ–º—É —Å—Ç–∏–ª—é "
                "–ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ —Å–æ —Å—Ä–µ–¥–Ω–µ–π –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç—å—é.\n\n"
                "–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –±–ª–∏–∑–æ—Å—Ç–∏ —Å–æ—á–µ—Ç–∞–µ—Ç—Å—è —Å –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ–º –∏ —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ–º "
                "–¥–∏—Å—Ç–∞–Ω—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è, —á—Ç–æ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–µ –≤–æ –≤—Å–µ—Ö, –Ω–æ –≤ –∑–Ω–∞—á–∏–º—ã—Ö "
                "–æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.\n\n"
                "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:\n"
                "–ü–æ–ª–µ–∑–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –æ—Å–æ–∑–Ω–∞–Ω–∏–µ–º –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã—Ö —Ä–µ–∞–∫—Ü–∏–π –Ω–∞ –±–ª–∏–∑–æ—Å—Ç—å "
                "–∏ —Å–Ω–∏–∂–µ–Ω–∏–µ–º —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Ç–∞–∫—Ç–µ."
            )
        else:
            result.append(
                "–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–≤–æ–∂–Ω–æ-–∏–∑–±–µ–≥–∞—é—â–µ–º—É —Å—Ç–∏–ª—é "
                "–ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ —Å –≤—ã—Å–æ–∫–æ–π –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç—å—é.\n\n"
                "–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç –º–µ–∂–¥—É –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å—é –≤ –±–ª–∏–∑–æ—Å—Ç–∏ –∏ —Å—Ç—Ä–∞—Ö–æ–º "
                "–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è —É—Å—Ç–æ–π—á–∏–≤–æ –∏ —á–∞—Å—Ç–æ –¥–µ–ª–∞–µ—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏—è "
                "–Ω–∞–ø—Ä—è–∂—ë–Ω–Ω—ã–º–∏ –∏ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–º–∏.\n\n"
                "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:\n"
                "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–∞–±–æ—Ç–∞ —Å–æ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–µ–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è "
                "–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –±–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è "
                "–≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö."
            )

    result.append(
        "–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–æ–±—Ä–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –ø–æ–Ω—è—Ç—å, –∫–∞–∫ –æ–Ω –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è "
        "–∏–º–µ–Ω–Ω–æ –≤ –≤–∞—à–∏—Ö —Ä–µ–∞–ª—å–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö, –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ "
        "–¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é:\n"
        "https://t.me/mserganin"
    )

    return "\n\n".join(result)

# -----------------------------
# –°–¢–ê–†–¢
# -----------------------------
@dp.message_handler(commands=["start"])
async def start_handler(message: types.Message):
    uid = message.from_user.id
    user_answers[uid] = []
    user_index[uid] = 0

    desc = "\n".join(ANSWER_TEXT[i] for i in range(1, 8))
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç
    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton("–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç", callback_data="start_test"))

    await message.answer(
        "–≠—Ç–æ –æ–ø—Ä–æ—Å–Ω–∏–∫ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –≤ –±–ª–∏–∑–∫–∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.\n\n"
        "–í–∞–º –±—É–¥—É—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω—ã 36 —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π.\n"
        "–û—Ü–µ–Ω–∏—Ç–µ –∏—Ö –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 –¥–æ 7.\n\n"
        f"{desc}",
        reply_markup=kb
    )

@dp.callback_query_handler(lambda c: c.data == "start_test")
async def start_test(call: types.CallbackQuery):
    uid = call.from_user.id
    user_index[uid] = 0
    await call.message.answer(
        f"–í–æ–ø—Ä–æ—Å 1 –∏–∑ 36:\n\n{QUESTIONS[0]}",
        reply_markup=scale_keyboard()
    )
    await call.answer()

@dp.callback_query_handler(lambda c: c.data.startswith("ans_"))
async def answer_handler(call: types.CallbackQuery):
    uid = call.from_user.id
    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ–±—ã –±–æ—Ç –Ω–µ –ø–∞–¥–∞–ª –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ
    if uid not in user_answers:
        user_answers[uid] = []
    if uid not in user_index:
        user_index[uid] = 0
    
    score = int(call.data.split("_")[1])
    user_answers[uid].append(score)
    user_index[uid] += 1

    if user_index[uid] < 36:
        qn = user_index[uid]
        await call.message.answer(
            f"–í–æ–ø—Ä–æ—Å {qn + 1} –∏–∑ 36:\n\n{QUESTIONS[qn]}",
            reply_markup=scale_keyboard()
        )
    else:
        # 1. –°—á–∏—Ç–∞–µ–º –±–∞–ª–ª—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        anxiety = sum(user_answers[uid][i] for i in ANXIETY_IDX)
        avoidance = sum(user_answers[uid][i] for i in AVOIDANCE_IDX)
        
        # 2. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é
        interpretation = interpret_attachment(anxiety, avoidance)
        
        # 3. –§–æ—Ä–º–∏—Ä—É–µ–º –µ–¥–∏–Ω–æ–µ –∫—Ä–∞—Å–∏–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        result_message = (
            f"üìä **–í–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**\n\n"
            f"üîπ **–¢—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å:** {anxiety}/126\n"
            f"üîπ **–ò–∑–±–µ–≥–∞–Ω–∏–µ:** {avoidance}/126\n\n"
            f"{interpretation}"
        )
        await call.message.answer(result_message, parse_mode="Markdown")
    
    await call.answer()

if __name__ == '__main__':
    port = int(os.environ.get("PORT", 10000))
    
    async def on_startup(app):
        # 1. –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, —á—Ç–æ–±—ã –±–æ—Ç –Ω–µ —Ç–æ—Ä–º–æ–∑–∏–ª –∏ –Ω–µ –¥–≤–æ–∏–ª—Å—è
        await bot.delete_webhook(drop_pending_updates=True)
        # 2. –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
        asyncio.create_task(dp.start_polling())
    
    app.on_startup.append(on_startup)
    
    # 3. –ó–∞–ø—É—Å–∫–∞–µ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è Render –Ω–∞ –ø–æ—Ä—Ç—É 10000
    web.run_app(app, host='0.0.0.0', port=port)
